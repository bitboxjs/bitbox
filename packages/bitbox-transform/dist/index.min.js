!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("bitbox-transform",t):(e.bitbox=e.bitbox||{},e.bitbox.transform=t())}(this,function(){"use strict";function e(e){return"function"==typeof e||!1}function t(t){t=t||{};var r={},n=0;return t.events={},t.getEvents=function(){return Object.keys(r)},t.update=function(e,r){var n={};if(r&&"string"==typeof e){var o=e;e={},e[o]=r}e&&"object"===("undefined"==typeof e?"undefined":l(e))&&Object.keys(e).map(function(r){t[r]!==e[r]&&(n[r]={old:t[r],new:e[r]},t[r]=e[r])}),t.emit("update",e,n)},t.sub=function(o,i){return e(i)&&(i._id="undefined"==typeof i._id?n++:i._id,o.replace(/\S+/g,function(e,t){(r[e]=r[e]||[]).push(i),i.typed=t>0})),t},t.on=function(){var o=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],i=arguments[1];return e(i)&&(i._id="undefined"==typeof i._id?n++:i._id,Array.isArray(o)||(o=[o]),o.map(function(e){"listener"!==e&&"update"!==e&&(t.events[e]=!0,t.emit("listener",e)),(r[e]=r[e]||[]).push(i)})),t},t.off=function(e,n){return"*"==e?r={}:(Array.isArray(e)||(e=[e]),e.map(function(e){if(n)for(var t,o=r[e],i=0;t=o&&o[i];++i)t._id==n._id&&(o.splice(i,1),i--);else r[e]=[]})),t},t.one=function(e,r){function n(){t.off(e,n),r.apply(t,arguments)}return t.on(e,n)},t.pub=function(e){for(var n,o=[].slice.call(arguments,1),i=r[e]||[],s=0;n=i[s];++s)n.busy||(n.busy=1,n.apply(t,n.typed?[e].concat(o):o),i[s]!==n&&s--,n.busy=0);return r.all&&"*"!=e&&t.trigger.apply(t,["*",e].concat(o)),t},t.emit=function(e){for(var n,o=[].slice.call(arguments,1),i=r[e]||[],s=0;n=i[s];++s)n.busy||(n.busy=1,n.apply(t,n.typed?[e].concat(o):o),i[s]!==n&&s--,n.busy=0);return r.all&&"*"!=e&&t.trigger.apply(t,["*",e].concat(o)),t},t.trigger=function(e){for(var n,o=[].slice.call(arguments,1),i=r[e]||[],s=0;n=i[s];++s)n.busy||(n.busy=1,n.apply(t,n.typed?[e].concat(o):o),i[s]!==n&&s--,n.busy=0);return r.all&&"*"!=e&&t.trigger.apply(t,["*",e].concat(o)),t},t}function r(e){e.source=e.source.replace(/<([a-z0-9-]+)(.*)=>(.*)<\/([a-z0-9-]+)>$/gm,"<$1$2=>$3"),m[e.name]=e}function n(e){return e}function o(e){var t=arguments.length<=1||void 0===arguments[1]?": ":arguments[1],r=arguments.length<=2||void 0===arguments[2]?", ":arguments[2],n=d({},e),o=Object.keys(n),s=[];return o.forEach(function(e){var r=n[e];"class"===e?s.push("className"+t+r):"style"===e?s.push(""+e+t+r):0===e.indexOf("...")?s.push(""+i(e)):e===r?s.push(""+i(e)):s.push(""+i(e)+t+r)}),s.join(r)}function i(e,t){if(e&&e.indexOf("-")>-1){var r=e.split("-");e=r.map(function(e,r){return t||0!==r?e.substr(0,1).toUpperCase()+e.substr(1):e}).join("")}return t?e.substr(0,1).toUpperCase()+e.substr(1):e}function s(e){return e}function a(e){this.parent=e,this.content="",this.spacer="",this.indent=e?e.indent:"",this.isFirstItem=!0}function p(e,t){e=e.replace(/(\()(<([a-z0-9-]+)(.*)=>([^\n<\/]+))(\))$/gm,"(<$3$4=>$5</$3>)"),e=e.replace(/<([a-z0-9-]+)(.*)=>([^\n<\/]+)$/gm,"<$1$2=>$3</$1>");var r=(new x).transform(e,t);return r.code=r.code.replace(/export(\w)/g,"export $1").replace(/export\sdefault(\w)/g,"export default $1").replace(/return(\w)/g,"return $1"),r.code}var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},u=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},c=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},f=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)},h={content:"content",a:"a",abbr:"abbr",address:"address",area:"area",article:"article",aside:"aside",audio:"audio",b:"b",base:"base",bdi:"bdi",bdo:"bdo",big:"big",blockquote:"blockquote",body:"body",br:"br",button:"button",canvas:"canvas",caption:"caption",cite:"cite",code:"code",col:"col",colgroup:"colgroup",data:"data",datalist:"datalist",dd:"dd",del:"del",details:"details",dfn:"dfn",dialog:"dialog",div:"div",dl:"dl",dt:"dt",em:"em",embed:"embed",fieldset:"fieldset",figcaption:"figcaption",figure:"figure",footer:"footer",form:"form",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",h6:"h6",head:"head",header:"header",hr:"hr",html:"html",i:"i",iframe:"iframe",img:"img",input:"input",ins:"ins",kbd:"kbd",keygen:"keygen",label:"label",legend:"legend",li:"li",link:"link",main:"main",map:"map",mark:"mark",menu:"menu",menuitem:"menuitem",meta:"meta",meter:"meter",nav:"nav",noscript:"noscript",object:"object",ol:"ol",optgroup:"optgroup",option:"option",output:"output",p:"p",param:"param",picture:"picture",pre:"pre",progress:"progress",q:"q",rp:"rp",rt:"rt",ruby:"ruby",s:"s",samp:"samp",script:"script",section:"section",select:"select",small:"small",source:"source",span:"span",strong:"strong",style:"style",sub:"sub",summary:"summary",sup:"sup",table:"table",tbody:"tbody",td:"td",textarea:"textarea",tfoot:"tfoot",th:"th",thead:"thead",time:"time",title:"title",tr:"tr",track:"track",u:"u",ul:"ul",var:"var",video:"video",wbr:"wbr",circle:"circle",clipPath:"clipPath",defs:"defs",ellipse:"ellipse",g:"g",line:"line",linearGradient:"linearGradient",mask:"mask",path:"path",pattern:"pattern",polygon:"polygon",polyline:"polyline",radialGradient:"radialGradient",rect:"rect",stop:"stop",svg:"svg",text:"text",tspan:"tspan"},m={},y={h:"bitbox.tag",element:"bitbox.element"},b=[],g={},v={clearMeta:function(){g={import:{},export:{},local:{}}},mustreturn:!1,lastNode:null,methods:[],pairs:{},routes:[],init:[],inlineThunks:[],body:"",observableKeys:[],delegateKeys:[],box:[],imports:[],exports:[],boxes:[],keys:{},bits:[],style:function(e){return e.props.scope='{ name: "'+e.parent.name+'", key: '+e.parent.props.key+" }",e.attrs.push({key:"text",type:"keyed",value:"text"}),this.tag(e)},script:function(e){return e.attrs.push({key:"text",type:"keyed",value:"text"}),this.tag(e)},styles:[],inits:[],convertprops:o,objectToArray:function(e){return Object.keys(e).map(function(t){return e[t]})},selfClosing:function(e){return e.content=-1,this.tag(e)},tag:function(e){this.lastNode=e;var t=h[e.name]===e.name,s="",a="",p="",l="";if(e.object||(e.object={}),e.object.attributes=[].concat(f(e.attrs)),e.attrs.length)for(var u in e.attrs){var c=e.attrs[u];if(c){if(c.rel&&"def"===c.rel){e.jsname=i(e.name),e.type="box",this.boxes.push(e);var m=c.value.trim();m=m?m.substr(0,m.length-1)+")":null,e.args=m;var v=["",""];"root"===e.parent||"mod"===e.parent.name;var x="",k="";"root"!==e.parent&&"mod"!==e.parent.name||e.props.export&&(x="\nexport ",e.props.default&&(x+="default "),delete e.props.export,delete e.props.default);this.bits.filter(function(e,t,r){return r.indexOf(e)===t}).map(function(e){return e[0]+": "+e[1]}).join(",");if(this.bits=[],s+="\n\t\t\t\t\t\t"+x+v[0]+" function "+i(e.name)+m+" {","root"===e.parent){var _=Object.keys(g.local).map(function(t){return"new bitbox("+e.jsname+"$box, "+t+")"});s+="",s+=this.inits.join("\n")+"\n",s+=_.join("\n")+"\n",this.keys={},this.inits=[],s=s.replace(/this\$box/g,e.jsname+"$box"),e.content=e.content.replace(/this\$box/g,e.jsname+"$box")}l+="}"+v[1]+k,delete e.props[c.key]}switch(c.key){case"text":c.value&&(e.content="`"+e.body.replace(/\`/gm,"\\`")+"`"),delete e.props.text;break;case"snippet":e.snippet=c.value,e.snippet&&(e.props.snippet=e.body?"`"+e.body.replace(/\`/gm,"\\`")+"`":null);break;case"if":s+="if "+c.value+" {",l="}",e.parent._if=!0,delete e.props.if;break;case"else":s+="else {",l="}",delete e.props.else;break;case"for":"invoke"===c.rel&&(a+="for "+c.value+" {",p="}",e.__tree=!0,delete e.props.for);break;case"switch":a+="switch "+c.value+" {",p="}",e._switch=!0,delete e.props.switch}if(c.key.endsWith(".map")){if(e.childrens>1)throw new Error("Only one root element allowed for map, got "+e.childrens+"\n"+e.body);a+=c.key+"("+c.value+" => ",p=")",delete e.props[c.key]}if(c.key.endsWith(".each")&&(a+=c.key.replace(".each",".forEach")+"("+c.value+" => {",p="})",e.__tree=!0,delete e.props[c.key]),"invoke"===c.rel&&e.props[c.key]){e.invoke=e.name+"."+c.key+c.value;var w=c.key.startsWith("-")?c.key.substr(1):c.key;e.props[c.key]=""+i(w)+c.value}}}e.return&&(e.content="return ("+e.content+")");var j="";if(e.props.export&&(j="\nexport ",e.props.default&&(j+="default "),delete e.props.export,delete e.props.default),e.props.case){var $="case "+e.props.case+":";if(e.props.key="'case-"+e.props.case.replace(/['"`]/g,"")+"'",e.props.case===!0){var O=Object.keys(e.props),C=O[O.indexOf("case")+1];e.props.key=C,delete e.props[C],$="default"===C?"default:":"case '"+C+"':"}s=""+$,l="break;",delete e.props.case}e.props.default&&e.parent.props.switch&&(s="default:",l="break;",delete e.props.default);var A=e.props?""+o(e.props):"",S="",E="",z=e.name;if("box"!==e.type)if("mod"===e.name)S="",E="";else if(z=""+i(e.name),e.content===-1){if(e.content="",e.invoke_zz);else if(g.local[z+"__s"]);else{var W=z;e.key&&(j=""+j+(e.key.indexOf(".")>-1?"":"const ")+i(e.key)+" = ");var q=e.parent.box||"root"===e.parent.parent?["",""]:["$tree.push(",");"],G=!1;e.props.new&&(G=!0,delete e.props.new),(e.props.return||e.parent.box)&&(q=["return(",")"],delete e.props.return),e.object.key=W,e.object.props="{"+A+"}";var N=e.comprop||e.dotprop||z,P="element"===N?""+y.element:N;e.parent.childrens="undefined"!=typeof e.parent.childrens?e.parent.childrens+1:1;var U=d({},e.props);A=U?""+o(U):"";var L=e.props.props||e.props["@"]?""+(e.props.props||e.props["@"].substring(1)):A?"{ "+A+" }":"",T=!e.name.startsWith("bitbox");S=G||t?""+q[0]+y.h+"('"+e.name+"'"+(L?",":"")+L+")"+q[1]:T?""+q[0]+y.h+"("+P+(L?",":"")+L+")"+q[1]:""+q[0]+P+"("+L+")"+q[1]}E=""}else if(g.local[z+"__s"]);else{e.key&&(j=""+j+(e.key.indexOf(".")>-1?"":"const ")+i(e.key)+" = ");var I=e.parent.box||"root"===e.parent.parent?["",""]:["$tree.push(",");"],K=!1;e.props.new&&(K=!0,delete e.props.new),(e.props.return||e.parent.box)&&(I=["return(",")"],delete e.props.return);var M=e.comprop||e.dotprop||z,B="element"===M?""+y.element:M,D=e.content.trim().length,F=/^\$tree\.push\(([\s\S]*)\)\;$/g,H=e.childrens>1||e._if||e._switch||e.__tree?["($tree => {","return $tree })([])"]:["",""];if(e.parent.childrens="undefined"!=typeof e.parent.childrens?e.parent.childrens+1:1,1!==e.childrens||e.__tree||(e.content=e.content.trim().replace(F,"$1")),2==e.snippet){var J=n(e.content,{indent_with_tabs:!0,indent_size:4}),Q=e.props.snippet;J="`"+J.replace(/\`/gm,"\\`")+"`",e.props.snippet="{ in: "+Q+", out: "+J+" }"}var R=d({},e.props);A=R?""+o(R):"";var V=e.props.props||e.props["@"]?""+(e.props.props||e.props["@"].substring(1)):A?"{ "+A+" }":"null",X=!e.name.startsWith("bitbox");S=K||t?""+I[0]+y.h+"('"+e.name+"'"+(V?",":"")+V+(D?",":"")+H[0]:X?""+I[0]+y.h+"("+B+(V?",":"")+V+(D?",":"")+H[0]:""+I[0]+B+"("+V+(V&&D?",":"")+H[0],E=H[1]+")"+I[1]}else if(e.returning)S="/** return **/\n",E="";else{var Y=d({},e.parent.props,e.props);delete Y.export,delete Y.default,delete Y[e.parent.name],A=Y?", {"+o(Y)+" }":"",z="'"+e.name+"'";e.args.replace("(","").replace(")","").split(","),e.props.register?"string"==typeof e.props.register&&e.props.register.indexOf("-")>-1?e.props.register:"'"+e.name+"-box'":"'"+e.name+"'";if(e.childrens>1)throw new Error("Box must have only one root element, got "+e.childrens+"\n"+e.body);S="",E="",r({js:(""+s+S+a+e.content+p+E+l).trim(),source:""+e.tag+e.body+"</"+e.name+">",name:""+e.name})}b[e.i]="undefined"!=typeof b[e.i]?b[e.i]+1:1;var Z="",ee=""+j+s+S+Z+a+e.content+p+E+l;return ee.trim()},isString:function(e){var t=/['"`]([^'`"]+)["'`]/g;return t.exec(e.trim())}};a.prototype.addSpace=function(e){this.spacer+=e,e.indexOf("\n")!==-1?this.indent=/[^\n]*$/.exec(e)[0]:this.indent+=e},a.prototype.add=function(e,t){this.content+=this.spacer,this.spacer="",this.content+=e};var x=function(){function e(){var r=this;arguments.length<=0||void 0===arguments[0]?{}:arguments[0];u(this,e),t(this),this.token={},this.chars=[],this.index=[],this.attrs=[],this.props={},this.nodes=[],this.text=[],this.tree={},this.result="",this.node={},this.token={"<":1,"</":1};var n=[],o=new a(null);o=new a(null);var i=0,s=!1;this.on("open",function(e,t){i++,"___bitbox"===e?t.component={key:t.attrs[0].key,attr:t.attrs}:t.component=t.parent.component,n.unshift([e,t.attrs]),o=new a(o),s=!0}),this.on("text",function(e){var t=e.split("\n"),r=!0;t.forEach(function(e){var t=/^(\s*)(.*?)(\s*)$/.exec(e),n=(t[1],t[2]);t[3];if(r||o.addSpace("\n"),n.length>0){var i=n[0];s!==!0||"`"!==i&&"'"!==i&&'"'!==i?o.add(n):o.add(n)}r=!1})}),this.on("close",function(e,t){s=!1;var r=(n.shift(),o.content);o=o.parent,t.content=r,"function"==typeof v[e]?o.add(v[e](t)):o.add(v.tag(t)),i--}),this.on("self-closing",function(e,t){"function"==typeof v[e]?o.add(v[e](t)):o.add(v.selfClosing(t))}),this.on("done",function(){r.compiled=o.content,r.write(r.compiled),o=new a(null)}),this.extract()}return c(e,[{key:"balanced",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],r=e.out?e.out:e.input,n=0,o=[],i=[],s="<",a=-1,p=0,l=0,u=0,c=!1,d=[],f=void 0,h=t.map(function(e){return e.charAt(0)}),m=t.map(function(e){return e.charAt(1)}),y=null,b=null,g=!1,v=r;e.pairs={},e.error=!1,e.return=!1,e.out="",e.props=e.props?e.props:[];var x=/^<([^\(\s\=\/\>]+)/,k=x.exec(r);if(k){var _=k[1].split(":");if(e.name=_[0],e.name.indexOf("[")>-1){var w=e.name.replace(/\[/g,".").replace(/\]/g,".");v=r=r.replace(e.name,w),e.comprop=""+e.name,e.name=w}e.name.indexOf(".")>-1&&(e.dotprop=""+e.name),e.key=_[1]||null}for(var j=0;j<r.length;j++){var $=r.charAt(j);if(e.pos=j,$===s&&"/"!==r.charAt(j+1)&&a===-1&&(a=j,p=j),a>-1){if(!g){var O=h.indexOf($);O>-1&&(y=$,b=m[O])}if($===y){if(g=y,n++,o.push(j),!c){var C=r.substring(0,j),A=C.replace(/\s+/g," ").split(" "),S=A.pop();f=S.length?S:A.pop()+" ",d.unshift(f)}c=!0}else if($===b){if(n--,i.push(j),0===n){var E=d.shift(),z=E.endsWith("=")?"assign":"invoke";0===E.indexOf("<")&&(e.box=!0,E=E.substr(1),z="def");var W=y+b;g=!1,y=null,b=null,c=!1,l=o.shift(),u=i.pop();var q=r.substring(l,u+1);e.__i=e.props.push({key:E.trim().replace("=",""),value:q,type:W,rel:z}),v=v.replace(E+q,e.__i),o=[],i=[]}if(n<0)return e.error="c < 0",e}if(">"===$&&0===n){"="===r[j-1]&&(e.return=!0),"/"===r[j-1]&&(e.selfClosing=!0);var G=r.substring(a,j+1);return e.tag=G,v=v.substring(p+1,j),v=v.split(">").shift().trim(),(e.return||e.selfClosing)&&(v=v.substring(0,v.length-1).trim()),a=0,e.out=v.replace(/\s+/g," ").trim(),e}}}return 0===n?e:(e.error="c !== 0",e)}},{key:"extract",value:function(){var e=this,t=0,r=null,n=0;this.on("<",function(o,i){var s=e.string(o);if(0!==s.indexOf("</")){var a=o+i.length,p=(s.slice(a),s),l=null;if(p.length){l=e.balanced({input:p,__i:0},["()","{}","[]"]),l.out=l.out.replace(/([\w\-]+)\s?=?\s?['"`]([^'`"]+)["'`]/g,function(e,t,r){var n="static";return l.__i=l.props.push({key:t,value:r,type:n,rel:"assign"}),l.__i}),n=o+l.pos,l.out.startsWith(l.name)&&(l.out=l.out.substr(l.name.length)),l.out=l.out.trim();var u=l.out.split(" ").map(function(t){var r=parseInt(t);if(r)return l.props[r-1];if(t.length){var n=t.split("=");return 2===n.length?{key:n[0],value:n[1],type:"value"}:0===t.indexOf("...")?{key:t,type:"spread"}:{key:t,value:e.toCamel(t.startsWith("-")?t.substr(1):t),type:"keyed"}}return null});l.props=u}l&&l.name&&!l.error&&!function(){var n=l.tag||"",s=l.name,a=l.key,p=l.props,u={};p.forEach(function(e,t){e&&(e.key===":"+a?delete l.props[t]:u[e.key]="static"===e.type?"'"+e.value+"'":e.value)});var c=e.index[e.index.length-1]?e.index[e.index.length-1]:"root";r={i:t,tag:n,name:s,key:a,attrs:p,props:u,parent:c,start:{pos:o,tok:i}},r.type=l.selfClosing?"self-closing":"normal",r.box=l.box;var d=r.name.match(/([a-z-0-9.]+)/);if(r.name=r.name&&d?d[1]:r.name,r.camelName=e.toCamel(r.name),r.comprop=l.comprop,r.dotprop=l.dotprop,e.text.length){var f=e.text.pop();f&&e.emit("text",e.string(f,o))}e.node=r,l.selfClosing?(r.body=null,e.text.push(o+n.length),e.emit("self-closing",s,r),e.emit("node",r)):(e.index.push(r),e.emit("open",s,r),e.text.push(o+n.length)),t++}()}}),this.on("</",function(n,o){var i=e.index.pop();if(i){var s=e.string(n,n+o.length+i.name.length+1);s==="</"+i.name+">"?(t--,r=i):(r=null,e.index.push(i))}if(r){if(r.body=e.string(r.start.pos+r.tag.length,n),r.box){var a=/(.+return([^<\/>]+)<\/>)/gm,p=a.exec(r.body+"</>");p&&(r.returning=p[2].trim())}if(r.end={pos:n,tok:o},r.type="normal",e.text.length){var l=e.text.pop();l&&e.emit("text",e.string(l,n))}e.text.push(n+o.length+r.name.length+1),e.emit("close",r.name,r),e.emit("node",r)}})}},{key:"toCamel",value:function(e,t){if(e&&e.indexOf("-")>-1){var r=e.split("-");e=r.map(function(e,r){return t||0!==r?e.substr(0,1).toUpperCase()+e.substr(1):e}).join("")}return t?e.substr(0,1).toUpperCase()+e.substr(1):e}},{key:"exprattr",value:function(e){e=e.replace(/\n/g," ").replace(/\t/g,"").trim();var t=/((\w+\.)+)?(\w+)\s?(\([^)]+\))/gi,r=[],n=e.replace(t,function(e,t,n,o,i,s){return r.push({type:o,expr:i,obj:t}),""});return{result:n,exprs:r}}},{key:"string",value:function(e,t){return"string"==typeof e?(this._string=e,this.result=this._string,this._string):this._string.slice(e,t)}},{key:"update",value:function(e,t){var r=this,n={};if(t&&"string"==typeof e){var o=e;e={},e[o]=t}e&&"object"===("undefined"==typeof e?"undefined":l(e))&&Object.keys(e).map(function(t){r[t]!==e[t]&&(n[t]={old:r[t],new:e[t]},r[t]=e[t])}),this.emit("update",e,n)}},{key:"run",value:function(){var e=this;this.chars=[],this.index=[],this.attrs=[],this.props={},this.nodes=[],this.text=[],this.tree={},this.result="",this.compiled="",this.emit("run",this.token);var t=this.string(0),r=!0,n=!1,o=void 0;try{for(var i,s=function(){var t=i.value,r=e.chars.push(t)-2;'"'!==t&&"`"!==t&&"'"!==t&&Object.keys(e.token).forEach(function(t){var n=e.string(r).startsWith(t);n===!0&&e.emit(t,r,t)})},a=t[Symbol.iterator]();!(r=(i=a.next()).done);r=!0)s()}catch(e){n=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(n)throw o}}return this.emit("done"),this.compiled}},{key:"fromString",value:function(e,t){return this.fn=t,this.source=e,this.string(e),this.emit("ready"),this.run()}},{key:"parse",value:function(e,t){return v.clearMeta(),v.boxes=[],this.fn=t,this.source=e,this.string(e),this.emit("ready"),this.run(),"function"==typeof t?t.call(null,this.source,this.compiled):s(this.compiled,{indent_with_tabs:!0,indent_size:4})}},{key:"transform",value:function(e){return{code:this.parse("<mod>"+e+"</mod>"),node:this.node}}},{key:"write",value:function(e){"function"==typeof this.fn&&this.fn.call(null,this.source,e)}}]),e}();return p.load=function(){var e=document.querySelectorAll('script[type="bitbox"]');e&&(console.warn("loading "+e.length+" scripts"),Array.prototype.map.call(e,function(e){if(e.bitboxLoaded)console.warn("already loaded @ "+e.bitboxLoaded+", ignore");else{e.bitboxLoaded=Date.now();var t=bitbox.transform(e.textContent),r=document.createElement("script");r.textContent=t,document.body.appendChild(r)}}))},p});